<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detailed statistics and analytics for ConfigStream proxy configurations">
    <meta name="keywords" content="vpn statistics, proxy analytics, performance metrics">
    
    <title>Statistics - ConfigStream</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="src/configstream/logo.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Design System -->
    <link rel="stylesheet" href="assets/css/framework.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        body {
            background: var(--bg-secondary);
        }
        
        .page-wrapper {
            min-height: 100vh;
            padding: var(--space-4);
        }
        
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
        }
        
        /* Navigation */
        .navbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .logo {
            width: 48px;
            height: 48px;
            transition: transform var(--transition-base);
        }
        
        .logo:hover {
            transform: rotate(10deg) scale(1.1);
        }
        
        .brand-name {
            font-size: var(--text-2xl);
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .nav-link {
            padding: var(--space-2) var(--space-4);
            color: var(--text-secondary);
            font-weight: 600;
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .nav-link:hover,
        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-primary);
        }
        
        .theme-toggle {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            border: 2px solid var(--border);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            margin-left: var(--space-4);
        }
        
        .theme-toggle:hover {
            background: var(--bg-primary);
            border-color: var(--primary-500);
            transform: scale(1.05);
        }
        
        /* Page Header */
        .page-header {
            padding: var(--space-10) var(--space-8);
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.05) 0%, 
                rgba(118, 75, 162, 0.05) 100%);
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .page-title {
            font-size: clamp(2rem, 4vw, 3rem);
            margin-bottom: var(--space-3);
        }
        
        .page-subtitle {
            font-size: var(--text-lg);
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Content */
        .content {
            padding: var(--space-8);
        }
        
        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-10);
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform var(--transition-base);
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-500);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }
        
        .stat-value {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 800;
            color: var(--primary-500);
            display: block;
            margin-bottom: var(--space-2);
            line-height: 1;
        }
        
        .stat-label {
            font-size: var(--text-base);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-trend {
            margin-top: var(--space-3);
            font-size: var(--text-sm);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-1);
        }
        
        .trend-up {
            color: var(--success);
        }
        
        .trend-down {
            color: var(--danger);
        }
        
        /* Chart Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: var(--space-8);
            margin-bottom: var(--space-10);
        }
        
        .chart-card {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        
        .chart-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-200);
        }
        
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }
        
        .chart-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--text-xl);
            font-weight: 700;
        }
        
        .chart-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .chart-action-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .chart-action-btn:hover {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }
        
        .chart-container {
            position: relative;
            height: 350px;
        }
        
        .chart-container canvas {
            max-height: 100%;
        }
        
        /* Full Width Charts */
        .chart-card-full {
            grid-column: 1 / -1;
        }
        
        .chart-container-full {
            height: 400px;
        }
        
        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-20);
            gap: var(--space-6);
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid var(--border);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: var(--text-lg);
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        /* Export Section */
        .export-section {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin-top: var(--space-10);
        }
        
        .export-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }
        
        .export-title {
            font-size: var(--text-2xl);
            font-weight: 700;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }
        
        .export-btn {
            padding: var(--space-4);
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-weight: 600;
        }
        
        .export-btn:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            transform: translateY(-2px);
        }
        
        .export-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: var(--space-8);
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
        }
        
        /* Dark mode */
        body.dark .theme-icon-light {
            display: none;
        }
        
        body:not(.dark) .theme-icon-dark {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .nav-links {
                width: 100%;
                flex-direction: column;
            }
            
            .nav-link {
                width: 100%;
                justify-content: center;
            }
            
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .chart-container-full {
                height: 350px;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="main-container">
            <!-- Navigation -->
            <nav class="navbar">
                <div class="logo-section">
                    <img src="src/configstream/logo.svg" alt="ConfigStream Logo" class="logo">
                    <span class="brand-name">ConfigStream</span>
                </div>
                
                <div class="nav-links">
                    <a href="index.html" class="nav-link">
                        <i data-feather="home"></i>
                        <span>Home</span>
                    </a>
                    <a href="proxies.html" class="nav-link">
                        <i data-feather="list"></i>
                        <span>Proxies</span>
                    </a>
                    <a href="statistics.html" class="nav-link active">
                        <i data-feather="bar-chart-2"></i>
                        <span>Statistics</span>
                    </a>
                    <a href="about.html" class="nav-link">
                        <i data-feather="info"></i>
                        <span>About</span>
                    </a>
                    
                    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                        <i data-feather="sun" class="theme-icon-light"></i>
                        <i data-feather="moon" class="theme-icon-dark"></i>
                    </button>
                </div>
            </nav>
            
            <!-- Page Header -->
            <header class="page-header">
                <h1 class="page-title">Statistics & Analytics</h1>
                <p class="page-subtitle">
                    Detailed insights into proxy configurations and performance metrics
                </p>
            </header>
            
            <!-- Loading Container -->
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading statistics...</div>
            </div>
            
            <!-- Content -->
            <div class="content" id="mainContent" style="display: none;">
                <!-- Stats Overview -->
                <section class="stats-overview">
                    <div class="stat-card animate-fade-in" style="animation-delay: 0.1s;">
                        <div class="stat-icon">
                            <i data-feather="database"></i>
                        </div>
                        <span class="stat-value" id="totalTested">0</span>
                        <span class="stat-label">Total Tested</span>
                    </div>
                    
                    <div class="stat-card animate-fade-in" style="animation-delay: 0.2s;">
                        <div class="stat-icon">
                            <i data-feather="check-circle"></i>
                        </div>
                        <span class="stat-value" id="totalWorking">0</span>
                        <span class="stat-label">Working</span>
                    </div>
                    
                    <div class="stat-card animate-fade-in" style="animation-delay: 0.3s;">
                        <div class="stat-icon">
                            <i data-feather="x-circle"></i>
                        </div>
                        <span class="stat-value" id="totalFailed">0</span>
                        <span class="stat-label">Failed</span>
                    </div>
                    
                    <div class="stat-card animate-fade-in" style="animation-delay: 0.4s;">
                        <div class="stat-icon">
                            <i data-feather="percent"></i>
                        </div>
                        <span class="stat-value" id="successRate">0%</span>
                        <span class="stat-label">Success Rate</span>
                    </div>
                    
                    <div class="stat-card animate-fade-in" style="animation-delay: 0.5s;">
                        <div class="stat-icon">
                            <i data-feather="zap"></i>
                        </div>
                        <span class="stat-value" id="avgLatency">0ms</span>
                        <span class="stat-label">Avg Latency</span>
                    </div>
                    
                    <div class="stat-card animate-fade-in" style="animation-delay: 0.6s;">
                        <div class="stat-icon">
                            <i data-feather="clock"></i>
                        </div>
                        <span class="stat-value" id="lastUpdate">—</span>
                        <span class="stat-label">Last Update</span>
                    </div>
                </section>
                
                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Protocol Distribution -->
                    <div class="chart-card animate-scale-in" style="animation-delay: 0.1s;">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i data-feather="pie-chart"></i>
                                <span>Protocol Distribution</span>
                            </div>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="downloadChart('protocolChart')" title="Download">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="protocolChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Country Distribution -->
                    <div class="chart-card animate-scale-in" style="animation-delay: 0.2s;">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i data-feather="globe"></i>
                                <span>Country Distribution</span>
                            </div>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="downloadChart('countryChart')" title="Download">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="countryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Full Width Charts -->
                <div class="charts-grid">
                    <!-- Top Countries Bar Chart -->
                    <div class="chart-card chart-card-full animate-scale-in" style="animation-delay: 0.3s;">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i data-feather="bar-chart-2"></i>
                                <span>Top 15 Countries by Proxy Count</span>
                            </div>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="downloadChart('topCountriesChart')" title="Download">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container chart-container-full">
                            <canvas id="topCountriesChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Latency Distribution -->
                    <div class="chart-card chart-card-full animate-scale-in" style="animation-delay: 0.4s;">
                        <div class="chart-header">
                            <div class="chart-title">
                                <i data-feather="activity"></i>
                                <span>Latency Distribution</span>
                            </div>
                            <div class="chart-actions">
                                <button class="chart-action-btn" onclick="downloadChart('latencyChart')" title="Download">
                                    <i data-feather="download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container chart-container-full">
                            <canvas id="latencyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Export Section -->
                <section class="export-section">
                    <div class="export-header">
                        <i data-feather="download" style="color: var(--primary-500);"></i>
                        <h2 class="export-title">Export Data</h2>
                    </div>
                    
                    <div class="export-buttons">
                        <button class="export-btn" id="exportStatsJSON">
                            <div class="export-icon">
                                <i data-feather="file-text"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">Statistics JSON</div>
                                <div style="font-size: var(--text-sm); color: var(--text-secondary);">Complete data export</div>
                            </div>
                        </button>
                        
                        <button class="export-btn" id="exportAllCharts">
                            <div class="export-icon">
                                <i data-feather="image"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">All Charts</div>
                                <div style="font-size: var(--text-sm); color: var(--text-secondary);">Download as images</div>
                            </div>
                        </button>
                        
                        <button class="export-btn" id="exportReport">
                            <div class="export-icon">
                                <i data-feather="file"></i>
                            </div>
                            <div>
                                <div style="font-weight: 700;">Full Report</div>
                                <div style="font-size: var(--text-sm); color: var(--text-secondary);">Comprehensive PDF</div>
                            </div>
                        </button>
                    </div>
                </section>
            </div>
            
            <!-- Footer -->
            <footer class="footer">
                <p>
                    <strong>ConfigStream</strong> • Statistics updated every 6 hours
                </p>
                <p style="margin-top: var(--space-2);">
                    Data generated: <span id="footerUpdate">Loading...</span>
                </p>
            </footer>
        </div>
    </div>
    
    <script>
        // Initialize Feather Icons
        feather.replace();
        
        // Global variables
        let statsData = null;
        let charts = {};
        
        // Path resolver
        const getBasePath = () => {
            const pathname = window.location.pathname;
            if (pathname.includes('/ConfigStream/')) {
                return '/ConfigStream/';
            }
            return pathname.endsWith('/') ? pathname : '/';
        };
        
        const BASE_PATH = getBasePath();
        
        // Fetch with path
        async function fetchWithPath(relativePath) {
            const cacheBust = `_=${new Date().getTime()}`;
            const separator = relativePath.includes('?') ? '&' : '?';
            const fullPath = `${BASE_PATH}${relativePath}${separator}${cacheBust}`;
            
            try {
                const response = await fetch(fullPath);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response;
            } catch (error) {
                console.error(`Failed to fetch ${fullPath}:`, error);
                throw error;
            }
        }
        
        // Chart.js default configuration
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.padding = 20;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        Chart.defaults.plugins.tooltip.padding = 12;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        Chart.defaults.plugins.tooltip.titleFont.size = 16;
        Chart.defaults.plugins.tooltip.bodyFont.size = 14;
        
        // Get chart colors based on theme
        function getChartColors() {
            const isDark = document.body.classList.contains('dark');
            return {
                primary: '#667eea',
                secondary: '#764ba2',
                success: '#10b981',
                warning: '#f59e0b',
                danger: '#ef4444',
                info: '#3b82f6',
                purple: '#8b5cf6',
                pink: '#ec4899',
                cyan: '#06b6d4',
                orange: '#f97316',
                emerald: '#059669',
                indigo: '#6366f1',
                grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                text: isDark ? '#cbd5e1' : '#64748b',
                background: isDark ? '#1f2937' : '#ffffff'
            };
        }
        
        // Update chart themes
        function updateChartThemes() {
            const colors = getChartColors();
            
            Object.values(charts).forEach(chart => {
                if (chart.options.scales) {
                    Object.keys(chart.options.scales).forEach(key => {
                        if (chart.options.scales[key].ticks) {
                            chart.options.scales[key].ticks.color = colors.text;
                        }
                        if (chart.options.scales[key].grid) {
                            chart.options.scales[key].grid.color = colors.grid;
                        }
                    });
                }
                
                if (chart.options.plugins?.legend?.labels) {
                    chart.options.plugins.legend.labels.color = colors.text;
                }
                
                chart.update('none');
            });
        }
        
        // Fetch and display statistics
        async function fetchStatistics() {
            const loadingEl = document.getElementById('loadingContainer');
            const contentEl = document.getElementById('mainContent');
            
            try {
                const response = await fetchWithPath('output/statistics.json');
                statsData = await response.json();
                
                // Update overview stats
                document.getElementById('totalTested').textContent = statsData.total_tested || 0;
                document.getElementById('totalWorking').textContent = statsData.working || 0;
                document.getElementById('totalFailed').textContent = statsData.failed || 0;
                document.getElementById('successRate').textContent = `${(statsData.success_rate || 0).toFixed(1)}%`;
                
                if (statsData.latency) {
                    document.getElementById('avgLatency').textContent = `${Math.round(statsData.latency.average || 0)}ms`;
                }
                
                // Update time
                const date = new Date(statsData.updated_at);
                const timeAgo = getTimeAgo(date);
                document.getElementById('lastUpdate').textContent = timeAgo;
                
                const formatted = date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });
                document.getElementById('footerUpdate').textContent = formatted;
                
                // Create charts
                createCharts();
                
                // Show content
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching statistics:', error);
                loadingEl.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3em; margin-bottom: var(--space-4); color: var(--danger);">⚠️</div>
                        <h3 style="font-size: var(--text-2xl); margin-bottom: var(--space-3);">Failed to Load Statistics</h3>
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">
                            ${error.message || 'Please try again later or check if the data files exist.'}
                        </p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i data-feather="refresh-cw"></i>
                            <span>Retry</span>
                        </button>
                    </div>
                `;
                feather.replace();
            }
        }
        
        // Get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            
            if (hours > 24) {
                const days = Math.floor(hours / 24);
                return `${days}d ago`;
            }
            if (hours > 0) {
                return `${hours}h ago`;
            }
            if (minutes > 0) {
                return `${minutes}m ago`;
            }
            return 'Just now';
        }
        
        // Create all charts
        function createCharts() {
            const colors = getChartColors();
            
            // Protocol Distribution (Doughnut)
            createProtocolChart(colors);
            
            // Country Distribution (Pie)
            createCountryChart(colors);
            
            // Top Countries (Bar)
            createTopCountriesChart(colors);
            
            // Latency Distribution (Line/Area)
            createLatencyChart(colors);
        }
        
        // Create protocol chart
        function createProtocolChart(colors) {
            const ctx = document.getElementById('protocolChart');
            const protocols = statsData.protocols || {};
            
            const chartColors = [
                colors.primary,
                colors.success,
                colors.info,
                colors.warning,
                colors.purple,
                colors.pink,
                colors.cyan,
                colors.orange
            ];
            
            charts.protocol = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(protocols).map(p => p.toUpperCase()),
                    datasets: [{
                        data: Object.values(protocols),
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Create country chart
        function createCountryChart(colors) {
            const ctx = document.getElementById('countryChart');
            const countries = statsData.countries || {};
            
            // Get top 8 countries
            const topCountries = Object.entries(countries)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            const chartColors = [
                colors.primary,
                colors.success,
                colors.info,
                colors.warning,
                colors.purple,
                colors.pink,
                colors.cyan,
                colors.orange
            ];
            
            charts.country = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: topCountries.map(c => c[0]),
                    datasets: [{
                        data: topCountries.map(c => c[1]),
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: colors.text,
                                padding: 15,
                                font: {
                                    size: 13,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Create top countries chart
        function createTopCountriesChart(colors) {
            const ctx = document.getElementById('topCountriesChart');
            const countries = statsData.countries || {};
            
            // Get top 15 countries
            const topCountries = Object.entries(countries)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            // Generate gradient colors
            const gradients = topCountries.map((_, i) => {
                const canvas = ctx;
                const gradient = canvas.getContext('2d').createLinearGradient(0, 0, 0, 400);
                const hue = (i * 25) % 360;
                gradient.addColorStop(0, `hsla(${hue}, 70%, 60%, 0.8)`);
                gradient.addColorStop(1, `hsla(${hue}, 70%, 50%, 0.9)`);
                return gradient;
            });
            
            charts.topCountries = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topCountries.map(c => c[0]),
                    datasets: [{
                        label: 'Proxy Count',
                        data: topCountries.map(c => c[1]),
                        backgroundColor: gradients,
                        borderWidth: 0,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Proxies: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.text,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: colors.text,
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: colors.grid,
                                drawBorder: false
                            }
                        }
                    },
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Create latency distribution chart
        async function createLatencyChart(colors) {
            const ctx = document.getElementById('latencyChart');
            
            // Fetch proxy data for latency information
            let latencies = [];
            try {
                const response = await fetchWithPath('output/proxies.json');
                const proxies = await response.json();
                latencies = proxies
                    .filter(p => p.latency !== null && p.latency !== undefined)
                    .map(p => p.latency)
                    .sort((a, b) => a - b);
            } catch (error) {
                console.error('Could not fetch latency data:', error);
            }
            
            // Create histogram data
            const bins = [0, 50, 100, 150, 200, 250, 300, 400, 500, 750, 1000, 2000];
            const histogram = new Array(bins.length - 1).fill(0);
            
            latencies.forEach(latency => {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (latency >= bins[i] && latency < bins[i + 1]) {
                        histogram[i]++;
                        break;
                    }
                }
            });
            
            const labels = bins.slice(0, -1).map((bin, i) => 
                `${bin}-${bins[i + 1]}ms`
            );
            
            // Create gradient
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
            gradient.addColorStop(1, 'rgba(118, 75, 162, 0.2)');
            
            charts.latency = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Proxy Count',
                        data: histogram,
                        backgroundColor: gradient,
                        borderColor: colors.primary,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: colors.primary,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `Latency Range: ${context[0].label}`;
                                },
                                label: function(context) {
                                    return `Proxies: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.text,
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: colors.text,
                                stepSize: 1,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: colors.grid,
                                drawBorder: false
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // Download chart as image
        function downloadChart(chartId) {
            const chart = charts[chartId.replace('Chart', '')];
            if (!chart) return;
            
            const url = chart.toBase64Image();
            const a = document.createElement('a');
            a.href = url;
            a.download = `${chartId}-${Date.now()}.png`;
            a.click();
        }
        
        // Export statistics JSON
        document.getElementById('exportStatsJSON').addEventListener('click', () => {
            const json = JSON.stringify(statsData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `configstream-statistics-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
        
        // Export all charts
        document.getElementById('exportAllCharts').addEventListener('click', async () => {
            for (const [name, chart] of Object.entries(charts)) {
                const url = chart.toBase64Image();
                const a = document.createElement('a');
                a.href = url;
                a.download = `${name}-chart-${Date.now()}.png`;
                a.click();
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        });
        
        // Export full report (placeholder)
        document.getElementById('exportReport').addEventListener('click', () => {
            alert('Full PDF report generation coming soon! For now, you can export individual charts and the JSON data.');
        });
        
        // Dark mode toggle
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        const savedTheme = localStorage.getItem('theme') || 
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        
        if (savedTheme === 'dark') {
            body.classList.add('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const theme = body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            
            // Update chart themes
            updateChartThemes();
            
            feather.replace();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatistics();
        });
    </script>
</body>
</html>