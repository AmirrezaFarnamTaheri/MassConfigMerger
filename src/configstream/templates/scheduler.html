{% extends "base.html" %}

{% block title %}Scheduler - ConfigStream{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <header class="bg-header-bg shadow-lg rounded-lg p-6 mb-8 flex items-center justify-between">
        <div class="flex items-center">
            <a href="/" class="flex items-center">
                <img src="{{ url_for('static', filename='logo.svg') }}" alt="ConfigStream Logo" class="h-12 w-12 mr-4">
                <div>
                    <h1 class="text-3xl font-bold text-white">ConfigStream</h1>
                    <p class="text-text-secondary">Scheduler Status</p>
                </div>
            </a>
        </div>
    </header>
    <div id="job-status-container" class="bg-card-bg shadow-lg rounded-lg p-6">
        <!-- Job status will be loaded here by JavaScript -->
    </div>
</div>
{% endblock %}

{% block head_extra %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    fetch('/api/scheduler/jobs')
        .then(async (response) => {
            if (!response.ok) {
                const msg = await response.text().catch(() => '');
                throw new Error(msg || `Failed to load jobs (${response.status})`);
            }
            return response.json().catch(() => { throw new Error('Invalid JSON from /api/scheduler/jobs'); });
        })
        .then((data) => {
            const container = document.getElementById('job-status-container');
            container.innerHTML = '';
            const jobs = Array.isArray(data) ? data : (Array.isArray(data && data.jobs) ? data.jobs : []);
            if (jobs.length > 0) {
                jobs.forEach(job => {
                    const jobElement = document.createElement('div');
                    jobElement.className = 'bg-header-bg p-4 rounded-md mb-4';

                    const title = document.createElement('h3');
                    title.className = 'text-lg font-semibold';
                    title.textContent = job && (job.name || job.id) ? (job.name || job.id) : 'Unnamed job';

                    const details = document.createElement('p');
                    details.className = 'text-text-secondary';
                    let nextRunText = 'N/A';
                    if (job && job.next_run_time) {
                        const d = new Date(job.next_run_time);
                        if (!isNaN(d)) nextRunText = d.toLocaleString();
                    }
                    details.textContent = `Next Run: ${nextRunText}`;

                    const button = document.createElement('button');
                    button.className = 'mt-2 bg-accent-color hover:bg-accent-color-hover text-white font-bold py-2 px-4 rounded-md';
                    button.textContent = 'Run Now';
                    button.addEventListener('click', async () => {
                        try {
                            const resp = await fetch('/api/scheduler/run', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': csrfToken
                                },
                                body: JSON.stringify({ id: job.id })
                            });
                            if (!resp.ok) {
                                const t = await resp.text().catch(() => '');
                                throw new Error(t || 'Failed to trigger job.');
                            }
                            alert('Job triggered.');
                        } catch (e) {
                            alert(e.message || 'Failed to trigger job.');
                        }
                    });

                    jobElement.appendChild(title);
                    jobElement.appendChild(details);
                    jobElement.appendChild(button);

                    container.appendChild(jobElement);
                });
            } else {
                container.innerHTML = '<p class="text-text-secondary">No scheduled jobs found.</p>';
            }
        })
        .catch((err) => {
            const container = document.getElementById('job-status-container');
            container.innerHTML = `<p class="text-text-secondary">Error loading jobs: ${err.message}</p>`;
        });
});
</script>
{% endblock %}