{% extends "base.html" %}

{% block title %}Dashboard - ConfigStream{% endblock %}

{% block header_title %}Dashboard{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div>
        <h1 class="text-4xl font-extrabold text-white">Dashboard</h1>
        <p class="mt-2 text-lg text-gray-400">
            A real-time overview of your proxy network's health and performance.
        </p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-blue-500/20 text-accent-blue-500"><i class="fas fa-network-wired fa-lg"></i></div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Total Nodes</p>
                    <p id="totalNodes" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-green-500/20 text-accent-green-500"><i class="fas fa-check-circle fa-lg"></i></div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Successful</p>
                    <p id="successfulNodes" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-yellow-500/20 text-accent-yellow-500"><i class="fas fa-tachometer-alt fa-lg"></i></div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Avg. Ping</p>
                    <p id="avgPing" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-purple-500/20 text-accent-purple-500"><i class="fas fa-globe-americas fa-lg"></i></div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Countries</p>
                    <p id="countryCount" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-3 card">
            <h2 class="text-2xl font-bold mb-4">Ping History</h2>
            <canvas id="pingHistoryChart"></canvas>
        </div>
        <div class="lg:col-span-2 card">
            <h2 class="text-2xl font-bold mb-4">Nodes by Country</h2>
            <canvas id="countryDistChart"></canvas>
        </div>
    </div>

    <!-- Node Table -->
    <div class="card overflow-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Live Nodes</h2>
            <div id="lastUpdate" class="text-sm text-gray-400">Loading...</div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="table-header">Protocol</th>
                        <th class="table-header">Country</th>
                        <th class="table-header">Ping</th>
                        <th class="table-header">IP Address</th>
                        <th class="table-header">Organization</th>
                    </tr>
                </thead>
                <tbody id="nodesTableBody" class="divide-y divide-gray-700"></tbody>
            </table>
            <div id="table-loading" class="text-center p-8 text-gray-400"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extra_script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    let currentData = { nodes: [], timestamp: null };
    let historyData = [];
    let pingHistoryChart, countryDistChart;

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        loadData();
        loadHistory();
        setInterval(loadData, 30000); // Refresh live data every 30s
    });

    function setLoading(isLoading) {
        document.getElementById('table-loading').style.display = isLoading ? 'block' : 'none';
        document.getElementById('nodesTableBody').style.display = isLoading ? 'none' : '';
    }

    async function loadData() {
        setLoading(true);
        try {
            const response = await fetch(`/api/current`, { cache: "no-store" });
            if (!response.ok) throw new Error(`Request failed: ${response.status}`);
            currentData = await response.json();
            if (!currentData || !Array.isArray(currentData.nodes)) throw new Error("Invalid response format");
            updateDashboard();
        } catch (err) {
            console.error("Error loading current data:", err);
            document.getElementById('lastUpdate').textContent = "Failed to load live data.";
        } finally {
            setLoading(false);
        }
    }

    async function loadHistory() {
        try {
            const response = await fetch(`/api/history?hours=24`);
            if (!response.ok) throw new Error(`Request failed: ${response.status}`);
            historyData = await response.json();
            updatePingHistoryChart();
        } catch (err) {
            console.error("Error loading history data:", err);
        }
    }

    function updateDashboard() {
        const { nodes, timestamp } = currentData;
        document.getElementById('lastUpdate').textContent = timestamp ? `Last Updated: ${new Date(timestamp).toLocaleString()}` : 'No data yet.';

        const successfulNodes = nodes.filter(n => n.ping_ms >= 0);
        const avgPing = successfulNodes.length > 0 ? (successfulNodes.reduce((acc, n) => acc + n.ping_ms, 0) / successfulNodes.length).toFixed(0) + ' ms' : '-';

        document.getElementById('totalNodes').textContent = nodes.length;
        document.getElementById('successfulNodes').textContent = successfulNodes.length;
        document.getElementById('avgPing').textContent = avgPing;
        document.getElementById('countryCount').textContent = new Set(nodes.map(n => n.country)).size;

        updateTable(nodes);
        updateCountryDistChart(nodes);
    }

    function updateTable(nodes) {
        const tableBody = document.getElementById('nodesTableBody');
        if (nodes.length === 0) {
            tableBody.innerHTML = `<tr><td class="px-6 py-4 text-center text-gray-400" colspan="5">No nodes available.</td></tr>`;
            return;
        }
        tableBody.innerHTML = nodes.slice(0, 10).map(node => { // Display top 10
            const pingVal = Number(node.ping_ms);
            const pingClass = !isFinite(pingVal) || pingVal < 0 ? 'text-red-400' :
                              pingVal < 250 ? 'text-green-400' :
                              pingVal < 600 ? 'text-yellow-400' : 'text-red-400';
            const pingDisplay = isFinite(pingVal) && pingVal >= 0 ? `${pingVal} ms` : 'Failed';
            return `
                <tr class="hover:bg-gray-800 transition-colors duration-200">
                    <td class="table-cell">${node.protocol || 'N/A'}</td>
                    <td class="table-cell">${node.country || 'N/A'}</td>
                    <td class="table-cell font-mono ${pingClass}">${pingDisplay}</td>
                    <td class="table-cell font-mono">${node.ip || 'N/A'}</td>
                    <td class="table-cell">${node.organization || 'N/A'}</td>
                </tr>`;
        }).join('');
    }

    function initCharts() {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } }
            }
        };

        const pingCtx = document.getElementById('pingHistoryChart').getContext('2d');
        pingHistoryChart = new Chart(pingCtx, {
            type: 'line',
            data: { datasets: [] },
            options: { ...commonOptions, scales: { ...commonOptions.scales, x: { type: 'time', time: { unit: 'hour' } } } }
        });

        const countryCtx = document.getElementById('countryDistChart').getContext('2d');
        countryDistChart = new Chart(countryCtx, {
            type: 'doughnut',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: '#9ca3af' } } }
            }
        });
    }

    function updatePingHistoryChart() {
        if (!historyData.length) return;
        const data = historyData.map(h => ({
            x: new Date(h.timestamp),
            y: h.avg_ping
        }));

        pingHistoryChart.data.datasets = [{
            label: 'Average Ping (ms)',
            data: data,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            fill: true,
            tension: 0.4
        }];
        pingHistoryChart.update();
    }

    function updateCountryDistChart(nodes) {
        const countryCounts = nodes.reduce((acc, node) => {
            if(node.country) acc[node.country] = (acc[node.country] || 0) + 1;
            return acc;
        }, {});

        const sortedCountries = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]).slice(0, 7);
        const labels = sortedCountries.map(c => c[0]);
        const data = sortedCountries.map(c => c[1]);

        countryDistChart.data.labels = labels;
        countryDistChart.data.datasets = [{
            data: data,
            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#d946ef'],
        }];
        countryDistChart.update();
    }
</script>
{% endblock %}