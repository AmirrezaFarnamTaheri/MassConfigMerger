{% extends "base.html" %}

{% block title %}Dashboard - ConfigStream{% endblock %}

{% block header_title %}Dashboard{% endblock %}

{% block head_extra %}
<script src="{{ url_for('static', filename='vendor/chart.js/chart.min.js') }}" defer></script>
<script src="{{ url_for('static', filename='vendor/chart.js/chartjs-adapter-date-fns.bundle.min.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Dashboard</h1>
        <div id="lastUpdate" class="text-sm text-gray-400">Loading...</div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-500/20 text-blue-400">
                    <i class="fas fa-globe-americas fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Total Nodes</p>
                    <p id="totalNodes" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-500/20 text-green-400">
                    <i class="fas fa-check-circle fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Successful</p>
                    <p id="successfulNodes" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-500/20 text-yellow-400">
                    <i class="fas fa-signal fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Avg. Ping</p>
                    <p id="avgPing" class="text-2xl font-bold text-white">-</p>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-500/20 text-purple-400">
                    <i class="fas fa-flag fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Countries</p>
                    <p id="countryCount" class="text-2xl font-bold text-white">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
        <div class="lg:col-span-3 card">
            <h2 class="text-xl font-semibold mb-4 text-white">Ping History (24h)</h2>
            <div class="h-64 relative">
                <canvas id="pingHistoryChart"></canvas>
            </div>
        </div>
        <div class="lg:col-span-2 card">
            <h2 class="text-xl font-semibold mb-4 text-white">Country Distribution</h2>
            <div class="h-64 relative">
                <canvas id="countryDistChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Nodes Table -->
    <div class="card">
        <h2 class="text-xl font-semibold mb-4 text-white">Recently Tested Nodes (Top 10)</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="table-header">Protocol</th>
                        <th class="table-header">Country</th>
                        <th class="table-header">Ping</th>
                        <th class="table-header">IP Address</th>
                        <th class="table-header">Organization</th>
                    </tr>
                </thead>
                <tbody id="nodesTableBody" class="bg-gray-900 divide-y divide-gray-800">
                    <!-- Loading state -->
                    <tr id="table-loading">
                        <td colspan="5" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin fa-2x text-gray-500"></i>
                            <p class="mt-2 text-gray-400">Loading data...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentData = { nodes: [], timestamp: null };
        let historyData = [];
        let pingHistoryChart, countryDistChart;

        const chartCommonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    bodyFont: { family: 'monospace' },
                    titleFont: { family: 'monospace' },
                }
            },
            scales: {
                x: {
                    ticks: { color: '#9ca3af', font: { family: 'monospace' } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#9ca3af', font: { family: 'monospace' } },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        };

        function initCharts() {
            const pingCtx = document.getElementById('pingHistoryChart').getContext('2d');
            pingHistoryChart = new Chart(pingCtx, {
                type: 'line',
                data: { datasets: [] },
                options: {
                    ...chartCommonOptions,
                    scales: {
                        ...chartCommonOptions.scales,
                        x: { type: 'time', time: { unit: 'hour' }, ...chartCommonOptions.scales.x },
                        y: { ...chartCommonOptions.scales.y, beginAtZero: true }
                    }
                }
            });

            const countryCtx = document.getElementById('countryDistChart').getContext('2d');
            countryDistChart = new Chart(countryCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#9ca3af', font: { family: 'monospace' } }
                        }
                    }
                }
            });
        }

        function setLoading(isLoading) {
            document.getElementById('table-loading').style.display = isLoading ? 'table-row' : 'none';
            if (!isLoading) {
                document.getElementById('nodesTableBody').style.display = '';
            }
        }

        async function loadData() {
            try {
                const response = await fetch('/api/current', { cache: 'no-store' });
                if (!response.ok) throw new Error(`Request failed: ${response.status}`);
                currentData = await response.json();
                if (!currentData || !Array.isArray(currentData.nodes)) {
                    throw new Error('Invalid response format');
                }
                updateDashboard();
            } catch (err) {
                console.error("Error loading current data:", err);
                document.getElementById('lastUpdate').textContent = "Failed to load live data.";
            } finally {
                setLoading(false);
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch('/api/history?hours=24');
                if (!response.ok) throw new Error(`Request failed: ${response.status}`);
                historyData = await response.json();
                updatePingHistoryChart();
            } catch (err) {
                console.error("Error loading history data:", err);
            }
        }

        function updateDashboard() {
            const { nodes, timestamp } = currentData;
            document.getElementById('lastUpdate').textContent = timestamp ? `Last Updated: ${new Date(timestamp).toLocaleString()}` : 'No data yet.';

            const successfulNodes = nodes.filter(n => n.ping_ms >= 0 && n.ping_ms !== null);
            const avgPing = successfulNodes.length > 0 ? (successfulNodes.reduce((acc, n) => acc + n.ping_ms, 0) / successfulNodes.length).toFixed(0) + ' ms' : 'N/A';

            document.getElementById('totalNodes').textContent = nodes.length;
            document.getElementById('successfulNodes').textContent = successfulNodes.length;
            document.getElementById('avgPing').textContent = avgPing;
            document.getElementById('countryCount').textContent = new Set(nodes.map(n => n.country).filter(Boolean)).size;

            updateTable(nodes);
            updateCountryDistChart(nodes);
        }

        function updateTable(nodes) {
            const tableBody = document.getElementById('nodesTableBody');
            const sortedNodes = nodes.sort((a,b) => (a.ping_ms === null ? 9999 : a.ping_ms) - (b.ping_ms === null ? 9999 : b.ping_ms));

            if (sortedNodes.length === 0) {
                tableBody.innerHTML = '<tr><td class="table-cell text-center" colspan="5">No nodes available.</td></tr>';
                return;
            }
            tableBody.innerHTML = sortedNodes.slice(0, 10).map(node => {
                const pingVal = node.ping_ms;
                const pingClass = pingVal === null || pingVal < 0 ? 'text-red-400' :
                                  pingVal < 250 ? 'text-green-400' :
                                  pingVal < 600 ? 'text-yellow-400' : 'text-red-400';
                const pingDisplay = pingVal !== null && pingVal >= 0 ? `${pingVal} ms` : 'Failed';
                return `
                    <tr class="hover:bg-gray-800 transition-colors duration-200">
                        <td class="table-cell">${node.protocol || 'N/A'}</td>
                        <td class="table-cell">${node.country || 'N/A'}</td>
                        <td class="table-cell font-mono ${pingClass}">${pingDisplay}</td>
                        <td class="table-cell font-mono">${node.ip || 'N/A'}</td>
                        <td class="table-cell truncate max-w-xs">${node.organization || 'N/A'}</td>
                    </tr>`;
            }).join('');
        }

        function updatePingHistoryChart() {
            if (!pingHistoryChart || !historyData.length) return;
            const data = historyData.map(h => ({
                x: new Date(h.timestamp),
                y: h.avg_ping
            }));

            pingHistoryChart.data.datasets = [{
                label: 'Average Ping (ms)',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointBackgroundColor: '#3b82f6'
            }];
            pingHistoryChart.update();
        }

        function updateCountryDistChart(nodes) {
            if (!countryDistChart) return;
            const countryCounts = nodes.reduce((acc, node) => {
                if(node.country) acc[node.country] = (acc[node.country] || 0) + 1;
                return acc;
            }, {});

            const sortedCountries = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]).slice(0, 7);
            const labels = sortedCountries.map(c => c[0]);
            const data = sortedCountries.map(c => c[1]);
            const otherCount = nodes.length - data.reduce((a, b) => a + b, 0);
            if (otherCount > 0) {
                labels.push('Other');
                data.push(otherCount);
            }


            countryDistChart.data.labels = labels;
            countryDistChart.data.datasets = [{
                data: data,
                backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#d946ef', '#6b7280'],
                borderColor: '#1f2937',
            }];
            countryDistChart.update();
        }

        initCharts();
        setLoading(true);
        loadData();
        loadHistory();

        setInterval(loadData, 60000); // Refresh live data every 60s
    });
</script>
{% endblock %}