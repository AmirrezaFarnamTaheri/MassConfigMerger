{% extends "base.html" %}

{% block title %}Settings - ConfigStream{% endblock %}

{% block header_title %}Application Settings{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/prism/prism-okaidia.css') }}">
<script src="{{ url_for('static', filename='vendor/prism/prism.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Application Settings</h1>
        <p class="mt-1 text-lg text-gray-400">
            A read-only view of the current application configuration.
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Information -->
        <div class="lg:col-span-1">
            <div class="card space-y-4">
                <h2 class="text-xl font-semibold text-white flex items-center">
                    <i class="fas fa-info-circle mr-3 text-accent-blue-500"></i>
                    Configuration Source
                </h2>
                <p class="text-gray-400">
                    These settings are loaded from your <code>config.yaml</code> file and environment variables.
                </p>
                <p class="text-gray-400">
                    To ensure security and prevent misconfiguration, settings cannot be edited through this web interface. Please modify your configuration files directly on the server.
                </p>
                <div class="pt-4 border-t border-gray-700">
                    <h3 class="font-semibold text-white mb-2">Need Help?</h3>
                    <a href="/documentation" class="text-accent-blue-400 hover:underline">
                        Read the Configuration Docs <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Right Column: Settings JSON -->
        <div class="lg:col-span-2">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-white">
                        Current Configuration
                    </h2>
                    <button type="button" id="copy-settings-btn" class="btn btn-secondary text-sm">
                        <i class="fas fa-clipboard mr-2"></i>
                        Copy JSON
                    </button>
                </div>
                <div class="bg-gray-900/50 border border-gray-700 rounded-lg overflow-hidden">
                    <pre><code id="settings-json" class="language-json">{{ settings | tojson(indent=2) }}</code></pre>
                </div>
                <p id="copy-feedback" class="text-sm mt-2 h-4" aria-live="polite"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const copyButton = document.getElementById('copy-settings-btn');
    const feedbackEl = document.getElementById('copy-feedback');
    const jsonCodeEl = document.getElementById('settings-json');

    if (copyButton && jsonCodeEl) {
        copyButton.addEventListener('click', () => {
            // Guard and reset classes/state each attempt
            if (feedbackEl) {
                feedbackEl.textContent = '';
                feedbackEl.classList.remove('text-red-400', 'text-green-400');
            }

            (async () => {
                const text = jsonCodeEl.textContent.trim();
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(text);
                    } else {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        ta.setAttribute('readonly', '');
                        ta.style.position = 'fixed';
                        ta.style.top = '-1000px';
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                    }
                    if (!feedbackEl) return;
                    feedbackEl.classList.remove('text-red-400');
                    feedbackEl.classList.add('text-green-400');
                    feedbackEl.textContent = 'Copied to clipboard!';
                    setTimeout(() => {
                        if (!feedbackEl) return;
                        feedbackEl.textContent = '';
                        feedbackEl.classList.remove('text-green-400');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy settings:', err);
                    if (!feedbackEl) return;
                    feedbackEl.classList.remove('text-green-400');
                    feedbackEl.classList.add('text-red-400');
                    feedbackEl.textContent = 'Could not access clipboard. Copy manually.';
                }
            })();
        });
    }

    if (window.Prism) {
        Prism.highlightAll();
    }
});
</script>
{% endblock %}