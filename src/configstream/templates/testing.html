{% extends "base.html" %}
{% block title %}Testing - ConfigStream{% endblock %}
{% block content %}
<div class="card">
    <h2>Manual Proxy Testing</h2>
    <form id="testForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <textarea id="proxy-input" placeholder="Paste proxy configurations (one per line)" rows="10" style="width: 100%; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);"></textarea>
        <button type="submit" style="margin-top: 1rem; padding: 0.75rem 2rem; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">Test Proxies</button>
    </form>
    <div id="results" style="margin-top: 2rem;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('testForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    const proxies = document.getElementById('proxy-input').value.split('\n').filter(p => p.trim() !== '');
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '<p>Testing...</p>';

    try {
        const response = await fetch('/api/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ proxies: proxies })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        let resultsHtml = '<h3>Results:</h3><ul>';
        data.results.forEach(result => {
            resultsHtml += `<li>${result.proxy}: ${result.status} (${result.ping})</li>`;
        });
        resultsHtml += '</ul>';
        resultsDiv.innerHTML = resultsHtml;
    } catch (error) {
        resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
    }
});
</script>
{% endblock %}