{% extends "base.html" %}

{% block title %}Manual Testing - ConfigStream{% endblock %}

{% block head_extra %}
<style>
    .result-card {
        transition: all 0.3s ease-in-out;
        border-left-width: 4px;
    }
    .result-card.success {
        border-left-color: #48bb78; /* green-500 */
    }
    .result-card.failure {
        border-left-color: #f56565; /* red-500 */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-white mb-2">Manual Configuration Tester</h1>
    <p class="text-gray-400 mb-8">
        Paste your proxy configurations below to test their connectivity and performance.
    </p>

    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <form id="test-form">
            <div class="mb-4">
                <label for="configs" class="block text-lg font-medium text-gray-300 mb-2">Configurations (one per line):</label>
                <textarea id="configs" name="configs" rows="10"
                          class="w-full p-3 bg-gray-900 text-gray-200 border border-gray-700 rounded-md focus:ring-2 focus:ring-accent-blue-500 focus:border-accent-blue-500 transition"
                          placeholder="e.g., vless://... or ss://..."></textarea>
            </div>
            <div class="flex items-center justify-end">
                <button type="submit" id="test-button" class="btn btn-primary text-lg">
                    <i class="fas fa-play-circle mr-2"></i>
                    <span id="button-text">Run Tests</span>
                    <i id="button-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </form>
    </div>

    <div id="results-container" class="mt-8">
        <h2 class="text-3xl font-bold text-white mb-4 hidden" id="results-title">Test Results</h2>
        <div id="results-summary" class="text-gray-400 mb-4"></div>
        <div id="results-list" class="space-y-4">
            <!-- Test results will be dynamically inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const testForm = document.getElementById('test-form');
    const testButton = document.getElementById('test-button');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');
    const resultsContainer = document.getElementById('results-container');
    const resultsTitle = document.getElementById('results-title');
    const resultsSummary = document.getElementById('results-summary');
    const resultsList = document.getElementById('results-list');

    // CSRF token for POST requests
    const csrfToken = "{{ csrf_token() }}";

    testForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const configs = document.getElementById('configs').value.trim();
        if (!configs) {
            alert('Please enter at least one configuration to test.');
            return;
        }

        // Disable button and show spinner
        testButton.disabled = true;
        buttonText.textContent = 'Testing...';
        buttonSpinner.classList.remove('hidden');

        // Clear previous results
        resultsList.innerHTML = '';
        resultsSummary.innerHTML = '';
        resultsTitle.classList.add('hidden');

        try {
            const response = await fetch('/api/retest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({ configs: configs.split('\\n') })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            const results = await response.json();
            displayResults(results);

        } catch (error) {
            console.error('Error during testing:', error);
            resultsSummary.innerHTML = `<p class="text-red-400">An error occurred: ${error.message}</p>`;
        } finally {
            // Re-enable button and hide spinner
            testButton.disabled = false;
            buttonText.textContent = 'Run Tests';
            buttonSpinner.classList.add('hidden');
            resultsTitle.classList.remove('hidden');
        }
    });

    function displayResults(results) {
        if (!results || results.length === 0) {
            resultsSummary.innerHTML = '<p>No results to display.</p>';
            return;
        }

        let successCount = 0;
        let failureCount = 0;

        results.forEach(result => {
            const card = document.createElement('div');
            card.className = 'result-card bg-gray-800 p-4 rounded-lg shadow-md';

            let content = '';
            if (result.success) {
                successCount++;
                card.classList.add('success');
                content = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-green-400">SUCCESS</p>
                        <p class="text-sm text-gray-400">Ping: ${result.ping_ms} ms</p>
                    </div>
                    <p class="text-sm text-gray-300 mt-2 truncate" title="${result.config}">${result.config}</p>
                    <div class="text-xs text-gray-500 mt-2">
                        <span>Country: ${result.geo.country_name || 'N/A'}</span> |
                        <span>ISP: ${result.geo.isp || 'N/A'}</span>
                    </div>
                `;
            } else {
                failureCount++;
                card.classList.add('failure');
                content = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-red-400">FAILURE</p>
                    </div>
                    <p class="text-sm text-gray-300 mt-2 truncate" title="${result.config}">${result.config}</p>
                    <p class="text-xs text-red-500 mt-2">Error: ${result.error || 'Unknown error'}</p>
                `;
            }
            card.innerHTML = content;
            resultsList.appendChild(card);
        });

        resultsSummary.innerHTML = `
            <p>Tested ${results.length} configurations.
            <span class="text-green-400">${successCount} successful</span>,
            <span class="text-red-400">${failureCount} failed</span>.
            </p>
        `;
    }
});
</script>
{% endblock %}