{% extends "base.html" %}

{% block title %}Backup & Restore - ConfigStream{% endblock %}

{% block content %}
<div class="card">
    <h2>
        <div class="card-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
            </svg>
        </div>
        Backup & Restore
    </h2>
    <p style="color: #64748b; margin-bottom: 2rem;">
        Export your application data (config, sources, history) to a zip file, or import it from a previous backup.
    </p>

    <div class="backup-actions">
        <div class="action-section">
            <h3>Export Backup</h3>
            <p>Download a zip archive of your current settings and data.</p>
            <a href="/api/export-backup" class="action-btn">Export Data</a>
        </div>
        <div class="action-section">
            <h3>Import Backup</h3>
            <p>Upload a zip archive to restore your application data.</p>
            <form id="import-form" enctype="multipart/form-data">
                <input type="file" id="backup-file" name="backup_file" accept=".zip">
                <button type="submit" class="action-btn">Import Data</button>
            </form>
        </div>
    </div>
</div>
<script>
    const importForm = document.getElementById('import-form');
    importForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('backup-file');
        const file = fileInput.files && fileInput.files[0];

        if (!file) {
            alert('Please select a file to upload.');
            return;
        }
        const nameLower = (file.name || '').toLowerCase();
        const hasZipExt = nameLower.endsWith('.zip');
        const looksDoubleExt = /\.(zip)\.[^.\s]+$/.test(nameLower); // e.g., .zip.exe
        const typeLower = (file.type || '').toLowerCase();
        const zipTypes = new Set(['application/zip', 'application/x-zip-compressed', 'application/x-zip', 'multipart/x-zip']);
        const hasZipMime = zipTypes.has(typeLower);
        const MAX_SIZE_BYTES = 50 * 1024 * 1024; // 50MB client hint
        if (file.size > MAX_SIZE_BYTES) {
          alert('Backup file is too large.');
          return;
        }
        if (looksDoubleExt || (!hasZipExt && !hasZipMime)) {
            alert('Please select a valid .zip backup file.');
            return;
        }

        const formData = new FormData();
        formData.append('backup_file', file);

        try {
            const response = await fetch('/api/import-backup', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errText = await response.text().catch(() => '');
                throw new Error(errText || `Import failed with status ${response.status}`);
            }

            const result = await response.json().catch(() => {
                throw new Error('Invalid JSON response from server.');
            });

            alert(result.message || 'Import completed.');
            window.location.reload();
        } catch (err) {
            console.error('Failed to import backup:', err);
            alert('Error: ' + (err && err.message ? err.message : 'Unknown error'));
        }
    });
</script>
<style>
    .backup-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }
    .action-section {
        background: #f8fafc;
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }
    .action-section h3 {
        margin-bottom: 0.5rem;
    }
    .action-section p {
        color: #64748b;
        margin-bottom: 1.5rem;
    }
    .action-btn {
        display: inline-block;
        text-align: center;
        padding: 0.875rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    #import-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
</style>
{% endblock %}