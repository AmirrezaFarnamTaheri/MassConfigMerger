{% extends "base.html" %}

{% block title %}System Monitoring - ConfigStream{% endblock %}

{% block header_title %}System Monitoring{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div>
        <h1 class="text-4xl font-extrabold text-white">System Monitoring</h1>
        <p class="mt-2 text-lg text-gray-400">
            An overview of the application's status, resource usage, and recent activity.
        </p>
    </div>

    <!-- System Status Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Uptime -->
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-blue-500/20 text-accent-blue-500">
                    <i class="fas fa-clock fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Uptime</p>
                    <p id="uptime" class="text-2xl font-bold text-white">Loading...</p>
                </div>
            </div>
        </div>
        <!-- CPU Usage -->
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-purple-500/20 text-accent-purple-500">
                    <i class="fas fa-microchip fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">CPU Usage</p>
                    <p id="cpu" class="text-2xl font-bold text-white">Loading...</p>
                </div>
            </div>
        </div>
        <!-- Memory Usage -->
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-green-500/20 text-accent-green-500">
                    <i class="fas fa-memory fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Memory</p>
                    <p id="memory" class="text-2xl font-bold text-white">Loading...</p>
                </div>
            </div>
        </div>
        <!-- Total Jobs -->
        <div class="card-glow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-accent-yellow-500/20 text-accent-yellow-500">
                    <i class="fas fa-tasks fa-lg"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-400">Active Jobs</p>
                    <p id="total-jobs" class="text-2xl font-bold text-white">{{ jobs|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- API Key Manager -->
        <div class="lg:col-span-1 card">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-key mr-3 text-accent-yellow-500"></i>
                API Access
            </h2>
            <p class="text-gray-400 mb-4">
                Secure endpoints such as logs and scheduler jobs require an <code>X-API-Key</code> header.
                Store the key locally in your browser to avoid repeated prompts.
            </p>
            <div class="space-y-3">
                <label for="api-key-input" class="block text-sm text-gray-400">API key</label>
                <input id="api-key-input" type="password" class="form-input w-full" placeholder="••••••">
                <div class="flex items-center gap-3">
                    <button type="button" id="save-api-key" class="btn btn-primary flex-1">
                        <i class="fas fa-save mr-2"></i>
                        Save key
                    </button>
                    <button type="button" id="clear-api-key" class="btn btn-secondary">
                        <i class="fas fa-eraser mr-2"></i>
                        Clear
                    </button>
                </div>
                <p id="api-key-feedback" class="text-sm"></p>
            </div>
        </div>

        <!-- Scheduler Jobs -->
        <div class="lg:col-span-1 card">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-calendar-alt mr-3 text-accent-blue-500"></i>
                Scheduler Jobs
            </h2>
            <div id="scheduler-content" class="space-y-4">
                {% if jobs %}
                    {% for job in jobs %}
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="font-semibold text-white">{{ job.name }}</p>
                        <p class="text-sm text-gray-400">
                            Next run: <span class="font-mono">{{ job.next_run_time.strftime('%Y-%m-%d %H:%M:%S %Z') if job.next_run_time else 'N/A' }}</span>
                        </p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-400">No scheduled jobs found.</p>
                {% endif %}
            </div>
        </div>

        <!-- Logs -->
        <div class="lg:col-span-2 card">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-file-alt mr-3 text-accent-green-500"></i>
                Application Logs
            </h2>
            <div id="logs-container" class="bg-gray-950 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm border border-gray-700">
                <pre id="logs-content" class="whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uptimeEl = document.getElementById('uptime');
    const memoryEl = document.getElementById('memory');
    const cpuEl = document.getElementById('cpu');
    const logsContentEl = document.getElementById('logs-content');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveApiKeyBtn = document.getElementById('save-api-key');
    const clearApiKeyBtn = document.getElementById('clear-api-key');
    const apiKeyFeedback = document.getElementById('api-key-feedback');

    const STORAGE_KEY = 'configstream_api_key';

    function getStoredApiKey() {
        try {
            return window.localStorage.getItem(STORAGE_KEY) || '';
        } catch (error) {
            console.warn('Unable to read localStorage for API key', error);
            return '';
        }
    }

    function persistApiKey(value) {
        try {
            if (value) {
                window.localStorage.setItem(STORAGE_KEY, value);
            } else {
                window.localStorage.removeItem(STORAGE_KEY);
            }
            return true;
        } catch (error) {
            console.warn('Unable to persist API key', error);
            return false;
        }
    }

    function buildAuthHeaders() {
        const key = getStoredApiKey();
        if (!key) {
            return {};
        }
        return { 'X-API-Key': key };
    }

    function setApiKeyFeedback(message, isError = false) {
        if (!apiKeyFeedback) {
            return;
        }
        apiKeyFeedback.textContent = message;
        apiKeyFeedback.className = `text-sm ${isError ? 'text-red-400' : 'text-green-400'}`;
    }

    if (apiKeyInput) {
        apiKeyInput.value = getStoredApiKey();
    }

    if (saveApiKeyBtn) {
        saveApiKeyBtn.addEventListener('click', () => {
            const newKey = apiKeyInput ? apiKeyInput.value.trim() : '';
            const success = persistApiKey(newKey);
            if (success) {
                setApiKeyFeedback(newKey ? 'API key saved for this browser.' : 'Cleared stored API key.');
                fetchLogs();
                fetchSchedulerJobs();
            } else {
                setApiKeyFeedback('Could not store the key. Check browser privacy settings.', true);
            }
        });
    }

    if (clearApiKeyBtn) {
        clearApiKeyBtn.addEventListener('click', () => {
            if (persistApiKey('')) {
                if (apiKeyInput) {
                    apiKeyInput.value = '';
                }
                setApiKeyFeedback('Cleared stored API key.');
                fetchLogs();
                fetchSchedulerJobs();
            } else {
                setApiKeyFeedback('Browser blocked clearing stored key.', true);
            }
        });
    }

    async function fetchSystemStatus() {
        try {
            const response = await fetch('/api/status');
            if (!response.ok) throw new Error(`Failed to fetch status: ${response.status}`);
            const data = await response.json();

            uptimeEl.textContent = data.uptime;
            memoryEl.textContent = `${data.memory.percent}% (${data.memory.used_mb.toFixed(0)} MB / ${data.memory.total_mb.toFixed(0)} MB)`;
            cpuEl.textContent = `${data.cpu.percent}%`;

        } catch (error) {
            console.error('Error fetching system status:', error);
            uptimeEl.textContent = 'Error';
            memoryEl.textContent = 'Error';
            cpuEl.textContent = 'Error';
        }
    }

    async function fetchLogs() {
        try {
            const response = await fetch('/api/logs', { headers: buildAuthHeaders() });
            if (response.status === 401) {
                logsContentEl.textContent = 'Logs are protected. Provide a valid API key above to view them.';
                return;
            }
            if (!response.ok) throw new Error(`Failed to fetch logs: ${response.status}`);
            const data = await response.json();
            logsContentEl.textContent = data.logs.join('\n');
        } catch (error) {
            console.error('Error fetching logs:', error);
            logsContentEl.textContent = 'Error loading logs.';
        }
    }

    async function fetchSchedulerJobs() {
        try {
            const response = await fetch('/api/scheduler/jobs', { headers: buildAuthHeaders() });
            if (response.status === 401) {
                const schedulerContainer = document.getElementById('scheduler-content');
                if (schedulerContainer) {
                    schedulerContainer.innerHTML = '<p class="text-gray-400">Scheduler jobs are protected. Provide an API key to load them.</p>';
                }
                return;
            }
            if (!response.ok) {
                throw new Error(`Failed to fetch jobs: ${response.status}`);
            }
            const data = await response.json();
            if (!data.jobs || !Array.isArray(data.jobs) || !data.jobs.length) {
                return;
            }
            const schedulerContainer = document.getElementById('scheduler-content');
            if (schedulerContainer) {
                schedulerContainer.innerHTML = data.jobs.map(job => `
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <p class="font-semibold text-white">${job.name || 'Job'}</p>
                        <p class="text-sm text-gray-400">
                            Next run: <span class="font-mono">${job.next_run_time || 'N/A'}</span>
                        </p>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Error fetching scheduler jobs:', error);
        }
    }

    fetchSystemStatus();
    fetchLogs();
    fetchSchedulerJobs();

    setInterval(fetchSystemStatus, 5000);
    setInterval(fetchLogs, 10000);
    setInterval(fetchSchedulerJobs, 15000);
});
</script>
{% endblock %}
