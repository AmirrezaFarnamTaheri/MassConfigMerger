{% extends "base.html" %}

{% block title %}Proxy History - ConfigStream{% endblock %}

{% block content %}
<div class="card">
    <h2>
        <div class="card-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.87-.96-7-5.05-7-9V8.26l7-3.12 7 3.12V11c0 3.95-3.13 8.04-7 9z"/>
            </svg>
        </div>
        Complete Proxy History
    </h2>

    <section class="summary">
        <div class="pill">üìä Total Tracked: {{ summary.total }}</div>
        <div class="pill">‚úÖ Healthy: {{ summary.healthy }}</div>
        <div class="pill">‚ö†Ô∏è Critical: {{ summary.critical }}</div>
        <div class="pill">‚ùì Untested: {{ summary.untested }}</div>
        <div class="pill">üïê Generated: {{ summary.generated_at }} UTC</div>
    </section>

    <div class="table-toolbar">
        <input type="text" id="searchInput" placeholder="Filter proxies...">
    </div>
    <table aria-label="Complete proxy history" id="historyTable">
        <thead>
            <tr>
                <th scope="col">Proxy</th>
                <th scope="col">Successes</th>
                <th scope="col">Failures</th>
                <th scope="col">Success Rate</th>
                <th scope="col">Tests</th>
                <th scope="col">Status</th>
                <th scope="col">Last Tested (UTC)</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
            {% if entries %}
                {% for entry in entries %}
                <tr>
                    <td>
                        <strong>{{ entry.key }}</strong>
                        <div class="geo">
                            {% if entry.country %}
                                {{ entry.country }}{% if entry.isp %} ¬∑ {{ entry.isp }}{% endif %}
                            {% elif entry.isp %}
                                {{ entry.isp }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ entry.successes }}</td>
                    <td>{{ entry.failures }}</td>
                    <td>{{ '%.2f'|format(entry.reliability_percent) }}%</td>
                    <td>{{ entry.tests }}</td>
                    <td><span class="status-badge {{ entry.status_class }}">{{ entry.status }}</span></td>
                    <td>{{ entry.last_tested }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="7">No proxy history recorded yet.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>
<script>
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('historyTableBody');
    const rows = tableBody.getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
            rows[i].style.display = found ? '' : 'none';
        }
    });
</script>
<style>
    .table-toolbar {
        margin-bottom: 1rem;
    }
    #searchInput {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
    }
</style>
{% endblock %}