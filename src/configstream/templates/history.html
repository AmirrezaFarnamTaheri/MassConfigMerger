{% extends "base.html" %}

{% block title %}History - ConfigStream{% endblock %}

{% block header_title %}Connection History{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <div class="card">
        <h1 class="text-2xl font-bold mb-4">Connection History</h1>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="table-header">Timestamp</th>
                        <th class="table-header">IP Address</th>
                        <th class="table-header">Protocol</th>
                        <th class="table-header">Ping (ms)</th>
                        <th class="table-header">Status</th>
                    </tr>
                </thead>
                <tbody id="history-table-body" class="divide-y divide-gray-700">
                    <!-- Data will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
    .table-header {
        padding: 0.75rem 1.5rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-light-200);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('history-table-body');

    async function fetchHistory() {
        try {
            const response = await fetch('/api/history');
            if (!response.ok) throw new Error('Failed to fetch history');
            const data = await response.json();

            if (!Array.isArray(data)) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">Unexpected response format.</td></tr>`;
                return;
            }

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No history found.</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => {
                const ts = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';
                const ping = (item.ping_ms !== null && item.ping_ms >= 0) ? `${item.ping_ms} ms` : 'Failed';
                const statusClass = item.test_success ? 'text-green-400' : 'text-red-400';
                const statusText = item.test_success ? 'Success' : 'Failed';

                return `
                    <tr class="hover:bg-gray-800">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${ts}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.ip || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.protocol || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${ping}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    </tr>
                `;
            }).join('');
        } catch (error) {
            console.error('Error fetching history:', error);
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-400">Error loading history.</td></tr>`;
        }
    }

    fetchHistory();
});
</script>
{% endblock %}