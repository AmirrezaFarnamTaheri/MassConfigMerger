{% extends "base.html" %}

{% block title %}Dashboard - ConfigStream{% endblock %}

{% block content %}
<div class="grid">
    <div class="card">
        <h2>
            <div class="card-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
            </div>
            Pipeline Actions
        </h2>
        <p style="color: #64748b; margin-bottom: 1rem;">
            Execute aggregation and merge operations. Provide the optional API token if enforcement is enabled.
        </p>
        <label class="token-label" for="apiToken">API Token (optional)</label>
        <input id="apiToken" type="password" placeholder="Enter token if configured" autocomplete="off" />
        <div class="button-row">
            <button class="action" id="aggregateBtn">Run Aggregation</button>
            <button class="action" id="mergeBtn">Run Merge</button>
        </div>
        <pre id="actionOutput" aria-live="polite">Awaiting action…</pre>
    </div>

    <div class="card">
        <h2>
            <div class="card-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                </svg>
            </div>
            Quick Links
        </h2>
        <p style="color: #64748b; margin-bottom: 1rem;">
            Access reports, metrics, and operational endpoints.
        </p>
        <ul class="links">
            <li><a href="/report">Latest Report<span>→</span></a></li>
            <li><a href="/metrics">Prometheus Metrics<span>→</span></a></li>
            <li><a href="/health">Health Check<span>→</span></a></li>
        </ul>
    </div>
</div>

<div class="card">
    <h2>
        <div class="card-icon">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
            </svg>
        </div>
        Top Performing Proxies
    </h2>
    <p style="color: #64748b; margin-bottom: 1rem;">
        Recent proxy test results ranked by reliability. <a href="/history" style="color: #667eea; font-weight: 600;">View all →</a>
    </p>
    <table class="history" aria-label="Top proxies preview">
        <thead>
            <tr>
                <th>Proxy</th>
                <th>Success Rate</th>
                <th>Tests</th>
                <th>Status</th>
                <th>Last Tested</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
            {% if history_preview %}
                {% for entry in history_preview %}
                <tr>
                    <td>
                        <strong>{{ entry.key }}</strong>
                        <div class="geo">
                            {% if entry.country %}
                                {{ entry.country }}{% if entry.isp %} · {{ entry.isp }}{% endif %}
                            {% elif entry.isp %}
                                {{ entry.isp }}
                            {% else %}
                                —
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ '%.2f'|format(entry.reliability_percent) }}%</td>
                    <td>{{ entry.tests }}</td>
                    <td><span class="status-badge {{ entry.status_class }}">{{ entry.status }}</span></td>
                    <td>{{ entry.last_tested }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="5">No proxy history recorded yet.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>
<script>
    const previewLimit = {{ preview_limit | tojson }};
    const historyTableBody = document.getElementById('historyTableBody');
    const output = document.getElementById('actionOutput');
    const tokenField = document.getElementById('apiToken');

    function setOutput(message, isError = false) {
        output.textContent = message;
        output.style.background = isError ? 'rgba(220, 38, 38, 0.9)' : 'rgba(15, 23, 42, 0.85)';
    }

    async function callAction(endpoint, buttonId) {
        const btn = document.getElementById(buttonId);
        const token = tokenField.value.trim();
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['X-API-Key'] = token;
        }
        setOutput('Running ' + endpoint + '…');
        btn.disabled = true;
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers,
                body: JSON.stringify(token ? { token } : {})
            });
            const payload = await response.json().catch(() => ({ error: 'Invalid JSON response' }));
            if (!response.ok) {
                throw new Error(payload.error || response.statusText);
            }
            setOutput(JSON.stringify(payload, null, 2));
        } catch (err) {
            console.error(err);
            setOutput('Error: ' + err.message, true);
        } finally {
            btn.disabled = false;
        }
    }

    document.getElementById('aggregateBtn').addEventListener('click', () => {
        callAction('/api/aggregate', 'aggregateBtn');
    });
    document.getElementById('mergeBtn').addEventListener('click', () => {
        callAction('/api/merge', 'mergeBtn');
    });

    async function refreshHistoryPreview() {
        try {
            const response = await fetch(`/api/history?limit=${previewLimit}`);
            if (!response.ok) return;
            const data = await response.json();
            const items = data.items || [];
            if (!items.length) {
                historyTableBody.innerHTML = '<tr><td colspan="5">No proxy history recorded yet.</td></tr>';
                return;
            }
            historyTableBody.innerHTML = items.map(entry => `
                <tr>
                    <td><strong>${entry.key}</strong><div class="geo">${entry.country ? entry.country + (entry.isp ? ' · ' + entry.isp : '') : (entry.isp || '—')}</div></td>
                    <td>${entry.reliability_percent.toFixed(2)}%</td>
                    <td>${entry.tests}</td>
                    <td><span class="status-badge ${entry.status_class}">${entry.status}</span></td>
                    <td>${entry.last_tested}</td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Failed to refresh history preview', err);
        }
    }

    refreshHistoryPreview();
</script>
{% endblock %}