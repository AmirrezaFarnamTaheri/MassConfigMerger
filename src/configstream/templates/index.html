{% extends "base.html" %}

{% block title %}Dashboard - ConfigStream{% endblock %}

{% block head_extra %}
<style>
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }
    .card h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: #1a202c;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .card-icon {
        width: 32px;
        height: 32px;
        padding: 6px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .button-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    button.action {
        flex: 1;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    button.action:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    #actionOutput {
        margin-top: 1.5rem;
        padding: 1.25rem;
        background: rgba(15, 23, 42, 0.85);
        color: #e2e8f0;
        border-radius: 10px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 0.875rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 80px;
        line-height: 1.6;
    }
    table.history {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid">
    <div class="card">
        <h2>
            <div class="card-icon">
                <i class="fas fa-cogs"></i>
            </div>
            Pipeline Actions
        </h2>
        <p style="color: #64748b; margin-bottom: 1rem;">
            Execute aggregation and merge operations. Provide the optional API token if enforcement is enabled.
        </p>
        <label class="token-label" for="apiToken">API Token (optional)</label>
        <input id="apiToken" type="password" placeholder="Enter token if configured" autocomplete="off" />
        <div class="button-row">
            <button class="action" id="aggregateBtn">Run Aggregation</button>
            <button class="action" id="mergeBtn">Run Merge</button>
        </div>
        <pre id="actionOutput" aria-live="polite">Awaiting action…</pre>
    </div>

    <div class="card">
        <h2>
            <div class="card-icon">
                <i class="fas fa-link"></i>
            </div>
            Quick Links
        </h2>
        <p style="color: #64748b; margin-bottom: 1rem;">
            Access reports, metrics, and operational endpoints.
        </p>
        <ul class="links">
            <li><a href="/report">Latest Report<span>→</span></a></li>
            <li><a href="/metrics">Prometheus Metrics<span>→</span></a></li>
            <li><a href="/health">Health Check<span>→</span></a></li>
        </ul>
    </div>
</div>

<div class="card">
    <h2>
        <div class="card-icon">
            <i class="fas fa-users"></i>
        </div>
        Top Performing Proxies
    </h2>
    <p style="color: #64748b; margin-bottom: 1rem;">
        Recent proxy test results ranked by reliability. <a href="/history" style="color: #667eea; font-weight: 600;">View all →</a>
    </p>
    <table class="history">
        <thead>
            <tr>
                <th>Proxy</th>
                <th>Success Rate</th>
                <th>Tests</th>
                <th>Status</th>
                <th>Last Tested</th>
            </tr>
        </thead>
        <tbody id="historyTableBody">
            {% if history_preview %}
                {% for entry in history_preview %}
                <tr>
                    <td>
                        <strong>{{ entry.key }}</strong>
                        <div class="geo">
                            {% if entry.country %}
                                {{ entry.country }}{% if entry.isp %} · {{ entry.isp }}{% endif %}
                            {% elif entry.isp %}
                                {{ entry.isp }}
                            {% else %}
                                —
                            {% endif %}
                        </div>
                    </td>
                    <td>{{ '%.2f'|format(entry.reliability_percent) }}%</td>
                    <td>{{ entry.tests }}</td>
                    <td><span class="status-badge {{ entry.status_class }}">{{ entry.status }}</span></td>
                    <td>{{ entry.last_tested }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="5">No proxy history recorded yet.</td></tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    const previewLimit = {{ preview_limit | tojson }};
    const historyTableBody = document.getElementById('historyTableBody');
    const output = document.getElementById('actionOutput');
    const tokenField = document.getElementById('apiToken');

    function setOutput(message, isError = false) {
        output.textContent = message;
        output.style.background = isError ? 'rgba(220, 38, 38, 0.9)' : 'rgba(15, 23, 42, 0.85)';
    }

    async function callAction(endpoint, buttonId) {
        const btn = document.getElementById(buttonId);
        const token = tokenField.value.trim();
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['X-API-Key'] = token;
        }
        setOutput('Running ' + endpoint + '…');
        btn.disabled = true;
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers,
                body: JSON.stringify(token ? { token } : {})
            });
            const payload = await response.json().catch(() => ({ error: 'Invalid JSON response' }));
            if (!response.ok) {
                throw new Error(payload.error || response.statusText);
            }
            setOutput(JSON.stringify(payload, null, 2));
        } catch (err) {
            console.error(err);
            setOutput('Error: ' + err.message, true);
        } finally {
            btn.disabled = false;
        }
    }

    document.getElementById('aggregateBtn').addEventListener('click', () => {
        callAction('/api/aggregate', 'aggregateBtn');
    });
    document.getElementById('mergeBtn').addEventListener('click', () => {
        callAction('/api/merge', 'mergeBtn');
    });

    async function refreshHistoryPreview() {
        try {
            const response = await fetch(`/api/history?limit=${previewLimit}`);
            if (!response.ok) return;
            const data = await response.json();
            const items = data.items || [];
            if (!items.length) {
                historyTableBody.innerHTML = '<tr><td colspan="5">No proxy history recorded yet.</td></tr>';
                return;
            }
            historyTableBody.innerHTML = items.map(entry => `
                <tr>
                    <td><strong>${entry.key}</strong><div class="geo">${entry.country ? entry.country + (entry.isp ? ' · ' + entry.isp : '') : (entry.isp || '—')}</div></td>
                    <td>${entry.reliability_percent.toFixed(2)}%</td>
                    <td>${entry.tests}</td>
                    <td><span class="status-badge ${entry.status_class}">${entry.status}</span></td>
                    <td>${entry.last_tested}</td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Failed to refresh history preview', err);
        }
    }

    refreshHistoryPreview();
</script>
{% endblock %}