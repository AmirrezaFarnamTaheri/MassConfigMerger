<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ConfigStream Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
            color: #1a202c;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
            text-align: center;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .logo-icon svg {
            width: 36px;
            height: 36px;
            fill: white;
        }

        .logo h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tagline {
            color: #64748b;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        /* Navigation Bar */
        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(to right, #f8fafc, #f1f5f9);
            color: #334155;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-icon {
            width: 32px;
            height: 32px;
            padding: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .button-row {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        button.action {
            flex: 1;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button.action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button.action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .links {
            list-style: none;
            display: grid;
            gap: 0.75rem;
        }

        .links a {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(to right, #f8fafc, #f1f5f9);
            border-radius: 10px;
            color: #334155;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .links a:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }

        .links a span {
            font-weight: 700;
            font-size: 1.2rem;
        }

        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s ease;
            margin-top: 0.5rem;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .token-label {
            font-weight: 600;
            color: #475569;
            margin-top: 1rem;
            display: block;
        }

        #actionOutput {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: rgba(15, 23, 42, 0.85);
            color: #e2e8f0;
            border-radius: 10px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 80px;
            line-height: 1.6;
        }

        table.history {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        table.history thead {
            background: linear-gradient(to right, #f8fafc, #f1f5f9);
        }

        table.history th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #475569;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        table.history td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }

        table.history tbody tr:hover {
            background: #f8fafc;
        }

        .geo {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-healthy {
            background: #dcfce7;
            color: #166534;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-untested {
            background: #f1f5f9;
            color: #475569;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .button-row {
                flex-direction: column;
            }

            .logo h1 {
                font-size: 2rem;
            }

            .nav-links {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5zm0 18c-3.87-.96-7-5.05-7-9V8.26l7-3.12 7 3.12V11c0 3.95-3.13 8.04-7 9z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </div>
                <h1>ConfigStream</h1>
            </div>
            <p class="tagline">VPN Configuration Management & Aggregation Platform</p>
        </header>

        <nav class="nav-bar">
            <div class="nav-links">
                <a href="/" class="nav-link active">üè† Dashboard</a>
                <a href="/sources" class="nav-link">üì° Sources</a>
                <a href="/analytics" class="nav-link">üìä Analytics</a>
                <a href="/history" class="nav-link">üìú Full History</a>
                <a href="/settings" class="nav-link">‚öôÔ∏è Settings</a>
                <a href="/api-docs" class="nav-link">üìö API Docs</a>
                <a href="/logs" class="nav-link">üìù Logs</a>
            </div>
        </nav>

        <div class="grid">
            <div class="card">
                <h2>
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    Pipeline Actions
                </h2>
                <p style="color: #64748b; margin-bottom: 1rem;">
                    Execute aggregation and merge operations. Provide the optional API token if enforcement is enabled.
                </p>
                <label class="token-label" for="apiToken">API Token (optional)</label>
                <input id="apiToken" type="password" placeholder="Enter token if configured" autocomplete="off" />
                <div class="button-row">
                    <button class="action" id="aggregateBtn">Run Aggregation</button>
                    <button class="action" id="mergeBtn">Run Merge</button>
                </div>
                <pre id="actionOutput" aria-live="polite">Awaiting action‚Ä¶</pre>
            </div>

            <div class="card">
                <h2>
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
                        </svg>
                    </div>
                    Quick Links
                </h2>
                <p style="color: #64748b; margin-bottom: 1rem;">
                    Access reports, metrics, and operational endpoints.
                </p>
                <ul class="links">
                    <li><a href="/report">Latest Report<span>‚Üí</span></a></li>
                    <li><a href="/metrics">Prometheus Metrics<span>‚Üí</span></a></li>
                    <li><a href="/health">Health Check<span>‚Üí</span></a></li>
                </ul>
            </div>
        </div>

        <div class="card">
            <h2>
                <div class="card-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                </div>
                Top Performing Proxies
            </h2>
            <p style="color: #64748b; margin-bottom: 1rem;">
                Recent proxy test results ranked by reliability. <a href="/history" style="color: #667eea; font-weight: 600;">View all ‚Üí</a>
            </p>
            <table class="history" aria-label="Top proxies preview">
                <thead>
                    <tr>
                        <th>Proxy</th>
                        <th>Success Rate</th>
                        <th>Tests</th>
                        <th>Status</th>
                        <th>Last Tested</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    {% if history_preview %}
                        {% for entry in history_preview %}
                        <tr>
                            <td>
                                <strong>{{ entry.key }}</strong>
                                <div class="geo">
                                    {% if entry.country %}
                                        {{ entry.country }}{% if entry.isp %} ¬∑ {{ entry.isp }}{% endif %}
                                    {% elif entry.isp %}
                                        {{ entry.isp }}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </div>
                            </td>
                            <td>{{ '%.2f'|format(entry.reliability_percent) }}%</td>
                            <td>{{ entry.tests }}</td>
                            <td><span class="status-badge {{ entry.status_class }}">{{ entry.status }}</span></td>
                            <td>{{ entry.last_tested }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="5">No proxy history recorded yet.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <footer>
            <p>ConfigStream v1.0 ¬∑ Secure VPN Configuration Management</p>
            <p style="margin-top: 0.5rem; font-size: 0.8rem;">Metrics refresh automatically. Reload after running actions to view latest data.</p>
        </footer>
    </div>

    <script>
        const previewLimit = {{ preview_limit | tojson }};
        const historyTableBody = document.getElementById('historyTableBody');
        const output = document.getElementById('actionOutput');
        const tokenField = document.getElementById('apiToken');

        function setOutput(message, isError = false) {
            output.textContent = message;
            output.style.background = isError ? 'rgba(220, 38, 38, 0.9)' : 'rgba(15, 23, 42, 0.85)';
        }

        async function callAction(endpoint, buttonId) {
            const btn = document.getElementById(buttonId);
            const token = tokenField.value.trim();
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['X-API-Key'] = token;
            }
            setOutput('Running ' + endpoint + '‚Ä¶');
            btn.disabled = true;
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(token ? { token } : {})
                });
                const payload = await response.json().catch(() => ({ error: 'Invalid JSON response' }));
                if (!response.ok) {
                    throw new Error(payload.error || response.statusText);
                }
                setOutput(JSON.stringify(payload, null, 2));
            } catch (err) {
                console.error(err);
                setOutput('Error: ' + err.message, true);
            } finally {
                btn.disabled = false;
            }
        }

        document.getElementById('aggregateBtn').addEventListener('click', () => {
            callAction('/api/aggregate', 'aggregateBtn');
        });
        document.getElementById('mergeBtn').addEventListener('click', () => {
            callAction('/api/merge', 'mergeBtn');
        });

        async function refreshHistoryPreview() {
            try {
                const response = await fetch(`/api/history?limit=${previewLimit}`);
                if (!response.ok) return;
                const data = await response.json();
                const items = data.items || [];
                if (!items.length) {
                    historyTableBody.innerHTML = '<tr><td colspan="5">No proxy history recorded yet.</td></tr>';
                    return;
                }
                historyTableBody.innerHTML = items.map(entry => `
                    <tr>
                        <td><strong>${entry.key}</strong><div class="geo">${entry.country ? entry.country + (entry.isp ? ' ¬∑ ' + entry.isp : '') : (entry.isp || '‚Äî')}</div></td>
                        <td>${entry.reliability_percent.toFixed(2)}%</td>
                        <td>${entry.tests}</td>
                        <td><span class="status-badge ${entry.status_class}">${entry.status}</span></td>
                        <td>${entry.last_tested}</td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to refresh history preview', err);
            }
        }

        refreshHistoryPreview();
    </script>
</body>
</html>